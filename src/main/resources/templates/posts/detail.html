<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>게시물 상세보기</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: #e0f2f1;
            color: #004d40;
            padding: 1em;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .container {
            width: 60%;
            margin: 2em auto;
            background-color: #fff;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .post-details {
            margin-bottom: 2em;
        }

        .post-details h2 {
            margin-top: 0;
        }

        .post-details .post-meta {
            color: #666;
            margin-bottom: 1em;
        }

        .post-details .post-content {
            white-space: pre-wrap;
        }

        .back-button {
            display: inline-block;
            padding: 0.5em 1em;
            background-color: #004d40;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
        }

        .back-button:hover {
            background-color: #00332e;
        }

        .comment-form {
            margin-top: 2em;
            padding: 1em;
            border-top: 1px solid #ddd;
            background-color: #e0f2f1;
            border-radius: 8px;
        }

        .comment-form h3 {
            margin-top: 0;
        }

        .comment-form .form-group {
            margin-bottom: 1em;
        }

        .comment-form label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: bold;
        }

        .comment-form textarea {
            width: 100%;
            padding: 0.5em;
            border: 1px solid #004d40;
            border-radius: 4px;
            resize: vertical;
        }

        .submit-button {
            display: inline-block;
            padding: 0.5em 1em;
            background-color: #004d40;
            color: #fff;
            text-decoration: none;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .submit-button:hover {
            background-color: #00332e;
        }

        .comments {
            margin-top: 2em;
        }

        .comment {
            display: flex;
            flex-direction: column;
            border-top: 1px solid #ddd;
            padding: 1em 0;
        }

        .comment p {
            margin: 0;
        }

        .comment-buttons {
            display: flex;
            gap: 0.5em;
        }

        .comment-buttons button {
            padding: 0.5em 1em;
            background-color: #004d40;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .comment-buttons button:hover {
            background-color: #00332e;
        }

        .comment-buttons .edit-btn {
            background-color: #00796b;
        }

        .comment-buttons .edit-btn:hover {
            background-color: #004d40;
        }
    </style>
</head>
<body>
<header class="header">
    <h1 class="title">게시물 상세보기</h1>
</header>
<div class="container">
    <div class="post-details">
        <h2 th:text="${post.title}">제목</h2>
        <div class="post-meta">
            <span th:text="'작성자: ' + ${name}">작성자 이름</span> |
            <span th:text="'작성일: ' + ${post.CreatedAt}">작성일</span>
            <span th:text="'클라이밍장 아이디: '+${gymId}">클라이밍장 아이디</span>
        </div>
        <div class="post-content" th:text="${post.content}">내용</div>
    </div>
    <div class="comment-form">
        <h3>댓글 작성</h3>
        <form id="comment-form" action="/api/postcomment" method="post">
            <input type="hidden" id="postId" name="postId" th:value="${post.id}">
            <input type="hidden" id="currentUserId" th:value="${currentUserId}">
            <input type="hidden" id="climbingId" th:value="${post.getClimbingGym().getId()}">
            <input type="hidden" name="userId" th:value="${post.getUser().getId()}">
            <input type="hidden" id="name" th:value="${post.getUser().getName()}">
            <div class="form-group">
                <label for="commentText">댓글 내용:</label>
                <textarea id="commentText" name="commentText" rows="4" required></textarea>
            </div>
            <button type="submit" class="submit-button">댓글 작성</button>
        </form>
    </div>
    <div class="comments" id="comments-list">
    </div>
    <a href="/postlist" class="back-button">목록으로 돌아가기</a>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const commentForm = document.getElementById('comment-form');
        const climbingId = document.getElementById('climbingId').value;
        const postId= document.getElementById('postId').value;
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault(); // 기본 제출 방지
            const formData = new FormData(commentForm);

            fetch('/api/postcomment', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('댓글 작성에 실패했습니다.');
                    }
                    return response.json(); // 댓글 작성 결과를 JSON으로 반환
                })
                .then(data => {
                    console.log("1 여기까지 성공.....")
                    addCommentToList(data); // 댓글을 목록에 추가
                    console.log("2 여기까지 되나용")
                    commentForm.reset(); // 폼 초기화
                    window.location.href = `/post/${climbingId}/${postId}`;
                })
                .catch(error => console.error('댓글 작성 중 오류 발생:', error));
        });

        fetch(`/api/getcomments?postId=${document.querySelector('input[name="postId"]').value}`)
            .then(response => response.json())
            .then(comments => {
                console.log("댓글 목록:", comments); // 디버깅용
                comments.forEach(comment => {
                    addCommentToList(comment);
                    console.log(comment);
                });
                console.log("댓글 로딩 성공");
            })
            .catch(error => console.error('댓글 로딩 중 오류 발생:', error));
    });


    function addCommentToList(comment) {
        console.log('Adding comment:', comment);
        const currentUserId = document.getElementById('currentUserId').value;
        let commentsList = document.getElementById('comments-list');

        const commentElement = document.createElement('div');
        commentElement.className = 'comment';
        commentElement.id = 'comment-' + comment.id;


        const isOwnComment = comment.userId === Number(currentUserId);
        commentElement.innerHTML = `
            <p><strong>${comment.name}</strong>: <span>${comment.commentText}</span></p>
            ${isOwnComment ? `
                <div class="comment-buttons">
                    <button class="edit-btn" onclick="editComment(${comment.id})">수정</button>
                    <button onclick="deleteComment(${comment.id})">삭제</button>
                </div>
            ` : ''}
        `;

        commentsList.appendChild(commentElement);
    }

    function editComment(commentId) {
        const commentElement = document.getElementById('comment-' + commentId);
        const commentContent = commentElement.querySelector('span').textContent;
        const newContent = prompt('댓글을 수정하세요:', commentContent);

        if (newContent) {
            fetch(`/api/updatecomment/${commentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: newContent })
            })
                .then(response => response.json())
                .then(data => {
                    commentElement.querySelector('span').textContent = newContent;
                })
                .catch(error => console.error('댓글 수정 중 오류 발생:', error));
        }
    }

    function deleteComment(commentId) {
        if (!confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
            return;
        }

        fetch(`/api/deletecomment/${commentId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('서버 응답이 실패했습니다');
                }
                document.getElementById('comment-' + commentId).remove();
            })
            .catch(error => console.error('댓글 삭제 중 오류 발생:', error));
    }
</script>
</body>
</html>
